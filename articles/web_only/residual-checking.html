<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="sdmTMB">
<title>Residual checking with sdmTMB • sdmTMB</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Residual checking with sdmTMB">
<meta property="og:description" content="sdmTMB">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.3.9006</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../../articles/model-description.html">sdmTMB model description</a>
    <a class="dropdown-item" href="../../articles/web_only/basic-intro.html">Introduction to modelling with sdmTMB</a>
    <a class="dropdown-item" href="../../articles/web_only/bayesian.html">Bayesian estimation with sdmTMB</a>
    <a class="dropdown-item" href="../../articles/web_only/cross-validation.html">Cross-validation for model evaluation and comparison</a>
    <a class="dropdown-item" href="../../articles/web_only/delta-models.html">Fitting delta (hurdle) models with sdmTMB</a>
    <a class="dropdown-item" href="../../articles/web_only/ggeffects.html">Visualizing marginal effects in sdmTMB models with ggeffects</a>
    <a class="dropdown-item" href="../../articles/web_only/index-standardization.html">Index standardization with sdmTMB</a>
    <a class="dropdown-item" href="../../articles/web_only/poisson-link.html">Poisson-link delta models</a>
    <a class="dropdown-item" href="../../articles/web_only/pretty-plots.html">Making pretty maps with sdmTMB output</a>
    <a class="dropdown-item" href="../../articles/web_only/residual-checking.html">Residual checking with sdmTMB</a>
    <a class="dropdown-item" href="../../articles/web_only/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a>
    <a class="dropdown-item" href="../../articles/web_only/threshold-models.html">Threshold modeling with sdmTMB</a>
    <a class="dropdown-item" href="../../articles/web_only/visreg.html">Visualizing sdmTMB conditional effects using visreg</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/pbs-assess/sdmTMB/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Residual checking with sdmTMB</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pbs-assess/sdmTMB/blob/HEAD/vignettes/web_only/residual-checking.Rmd" class="external-link"><code>vignettes/web_only/residual-checking.Rmd</code></a></small>
      <div class="d-none name"><code>residual-checking.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://pbs-assess.github.io/sdmTMB/index.html">documentation
site</a> under ‘Articles’.</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pbs-assess.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span></code></pre></div>
<p>We will start with some data simulated from scratch. We will simulate
from an NB2 negative binomial observation model, a spatial random field,
an intercept, and one predictor named ‘a1’ that will have a linear
effect on the observed data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">predictor_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, a1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">predictor_dat</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../../reference/families.html">nbinom2</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  phi <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="co"># B0 = intercept, B1 = a1 slope</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we will fit versions with various responses and predictors. The
first model will use the Poisson instead of the NB2. The 2nd model will
match the simulated data. The third model is missing the ‘a1’ predictor.
We’ll use a PC prior on the Matérn parameters to aid in estimation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/priors.html">pc_matern</a></span><span class="op">(</span>range_gt <span class="op">=</span> <span class="fl">0.1</span>, sigma_lt <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a1</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="../../reference/priors.html">sdmTMBpriors</a></span><span class="op">(</span>matern_s <span class="op">=</span> <span class="va">pc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_pois</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 1 + a1</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: dat</span></span>
<span><span class="co">#&gt; Family: poisson(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)    -0.17    0.34</span></span>
<span><span class="co">#&gt; a1              0.65    0.02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matérn range: 0.13</span></span>
<span><span class="co">#&gt; Spatial SD: 2.40</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 3187.274</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span>
<span></span>
<span><span class="va">fit_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a1</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="fu"><a href="../../reference/families.html">nbinom2</a></span><span class="op">(</span><span class="op">)</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="../../reference/priors.html">sdmTMBpriors</a></span><span class="op">(</span>matern_s <span class="op">=</span> <span class="va">pc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_nb2</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 1 + a1</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: dat</span></span>
<span><span class="co">#&gt; Family: nbinom2(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)     0.52    0.14</span></span>
<span><span class="co">#&gt; a1              0.59    0.08</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.21</span></span>
<span><span class="co">#&gt; Matérn range: 0.20</span></span>
<span><span class="co">#&gt; Spatial SD: 0.51</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1542.780</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span>
<span></span>
<span><span class="va">fit_nb2_miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="fu"><a href="../../reference/families.html">nbinom2</a></span><span class="op">(</span><span class="op">)</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="../../reference/priors.html">sdmTMBpriors</a></span><span class="op">(</span>matern_s <span class="op">=</span> <span class="va">pc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_nb2_miss</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 1</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: dat</span></span>
<span><span class="co">#&gt; Family: nbinom2(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)     0.63    0.15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.19</span></span>
<span><span class="co">#&gt; Matérn range: 0.15</span></span>
<span><span class="co">#&gt; Spatial SD: 0.75</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1572.703</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>We can see just by looking at these fits that the Poisson model
inflates the spatial random field standard deviation (SD) compared to
the truth. The model missing the ‘a1’ predictor does so to a lesser
degree.</p>
<p>Here are randomized quantile residuals at fixed effect MLEs (Maximum
Likelihood Estimates) and random effects that maximize the log
likelihood at estimated fixed effects:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rq_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt; Note what used to be the default sdmTMB residuals (before version 0.4.3.9005)</span></span>
<span><span class="co">#&gt; are now `type = 'mle-eb'`. We recommend using the current default `'mle-mvn'`,</span></span>
<span><span class="co">#&gt; which takes one sample from the approximate posterior of the random effects or</span></span>
<span><span class="co">#&gt; `dharma_residuals()` using a similar approach.</span></span>
<span><span class="va">rq_res</span> <span class="op">&lt;-</span> <span class="va">rq_res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span><span class="op">]</span> <span class="co"># some Inf</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqline</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">rq_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit_nb2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Note what used to be the default sdmTMB residuals (before version 0.4.3.9005)</span></span>
<span><span class="co">#&gt; are now `type = 'mle-eb'`. We recommend using the current default `'mle-mvn'`,</span></span>
<span><span class="co">#&gt; which takes one sample from the approximate posterior of the random effects or</span></span>
<span><span class="co">#&gt; `dharma_residuals()` using a similar approach.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqline</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-3-2.png" width="672"></p>
<p>These use the approach from Dunn and Smyth (1996). They are also
known as PIT (probability-integral-transform) residuals. They apply
randomization to integer response values, transform the residuals using
the distribution function (e.g., <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm()</a></code>), simulate from a
uniform distribution, and transform the samples such that they would be
Gaussian if consistent with the model. You can see the source code at <a href="https://github.com/pbs-assess/sdmTMB/blob/master/R/residuals.R" class="external-link uri">https://github.com/pbs-assess/sdmTMB/blob/master/R/residuals.R</a></p>
<p>We can see here that there are likely issues with the Poisson model
in the tails.</p>
<p>These types of residuals are known to have statistical issues for
state-space models; even if the model is the ‘correct’ model, the QQ
plot may appear to have problems (Thygesen et al. 2017).</p>
<p>One-step-ahead residuals (Thygesen et al. 2017) are one option to fix
this problem (although slow to calculate). Another option is to take a
draw from the posterior with MCMC (e.g., Rufener et al. 2021). Also see
<a href="https://kaskr.github.io/adcomp/_book/Validation.html" class="external-link uri">https://kaskr.github.io/adcomp/_book/Validation.html</a></p>
<p>Here we will draw MCMC predictions and calculate residuals. The fixed
effects will be fixed at their maximum likelihood estimates (MLE) and
the random effects will be sampled. We do this with the
<code><a href="https://rdrr.io/pkg/sdmTMBextra/man/predict_mle_mcmc.html" class="external-link">sdmTMBextra::predict_mle_mcmc()</a></code> function in the sdmTMBextra
package: <a href="https://github.com/pbs-assess/sdmTMBextra" class="external-link uri">https://github.com/pbs-assess/sdmTMBextra</a>. We will only
take a single draw for speed:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">samps</span> <span class="op">&lt;-</span> <span class="fu">sdmTMBextra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sdmTMBextra/man/predict_mle_mcmc.html" class="external-link">predict_mle_mcmc</a></span><span class="op">(</span><span class="va">fit_nb2</span>, mcmc_iter <span class="op">=</span> <span class="fl">201</span>, mcmc_warmup <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'tmb_generic' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.000856 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 8.56 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 201 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  20 / 201 [  9%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  40 / 201 [ 19%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  60 / 201 [ 29%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  80 / 201 [ 39%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 100 / 201 [ 49%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 120 / 201 [ 59%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 140 / 201 [ 69%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 160 / 201 [ 79%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 180 / 201 [ 89%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 201 [ 99%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 201 / 201 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 2.315 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                0.014 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                2.329 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="va">mcmc_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit_nb2</span>, type <span class="op">=</span> <span class="st">"mle-mcmc"</span>, mcmc_samples <span class="op">=</span> <span class="va">samps</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">mcmc_res</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqline</a></span><span class="op">(</span><span class="va">mcmc_res</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>We can see these look a bit better. Remember, this is the ‘correct’
model.</p>
<p>We can take simulations from the fitted model to use with
simulation-based residuals:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_pois</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="va">s_nb2_miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_nb2_miss</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="va">s_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_nb2</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span></code></pre></div>
<p>These return a matrix where each row represents a row of data and
each column is a simulation draw:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">s_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1000  500</span></span></code></pre></div>
<p>Test whether fitted models are consistent with the observed number of
zeros:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">observed</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.634</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_pois</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">s_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.352376</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_nb2</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">s_nb2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.644674</span></span></code></pre></div>
<p>There are obviously too few zeros in the data simulated from the
Poisson model.</p>
<p>Plot DHARMa residuals:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_pois</span>, nsim <span class="op">=</span> <span class="fl">300</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">fit_pois</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>We did that with the sdmTMBextra package <a href="https://github.com/pbs-assess/sdmTMBextra" class="external-link uri">https://github.com/pbs-assess/sdmTMBextra</a>.</p>
<p>We could also do that manually, which lets us use other DHARMa
tools:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># My reading of DHARMa documation is that the predicted response for the </span></span>
<span><span class="co"># residuals vs. fitted plot should ideally not include the random effects:</span></span>
<span><span class="va">pred_fixed</span> <span class="op">&lt;-</span> <span class="va">fit_pois</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">linkinv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_pois</span><span class="op">)</span><span class="op">$</span><span class="va">est_non_rf</span><span class="op">)</span></span>
<span><span class="va">r_pois</span> <span class="op">&lt;-</span> <span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/createDHARMa.html" class="external-link">createDHARMa</a></span><span class="op">(</span></span>
<span>  simulatedResponse <span class="op">=</span> <span class="va">s_pois</span>,</span>
<span>  observedResponse <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">observed</span>,</span>
<span>  fittedPredictedResponse <span class="op">=</span> <span class="va">pred_fixed</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r_pois</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/testResiduals.html" class="external-link">testResiduals</a></span><span class="op">(</span><span class="va">r_pois</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-2.png" width="672"></p>
<pre><code><span><span class="co">#&gt; $uniformity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput$scaledResiduals</span></span>
<span><span class="co">#&gt; D = 0.23222, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dispersion</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa nonparametric dispersion test via sd of residuals fitted vs.</span></span>
<span><span class="co">#&gt;  simulated</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; dispersion = 3.9022, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two.sided</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $outliers</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa outlier test based on exact binomial test with approximate</span></span>
<span><span class="co">#&gt;  expectations</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; outliers at both margin(s) = 127, observations = 1000, p-value &lt;</span></span>
<span><span class="co">#&gt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: true probability of success is not equal to 0.003992016</span></span>
<span><span class="co">#&gt; 95 percent confidence interval:</span></span>
<span><span class="co">#&gt;  0.1069843 0.1492400</span></span>
<span><span class="co">#&gt; sample estimates:</span></span>
<span><span class="co">#&gt; frequency of outliers (expected: 0.00399201596806387 ) </span></span>
<span><span class="co">#&gt;                                                  0.127</span></span>
<span><span class="co">#&gt; $uniformity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput$scaledResiduals</span></span>
<span><span class="co">#&gt; D = 0.23222, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dispersion</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa nonparametric dispersion test via sd of residuals fitted vs.</span></span>
<span><span class="co">#&gt;  simulated</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; dispersion = 3.9022, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two.sided</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $outliers</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa outlier test based on exact binomial test with approximate</span></span>
<span><span class="co">#&gt;  expectations</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; outliers at both margin(s) = 127, observations = 1000, p-value &lt;</span></span>
<span><span class="co">#&gt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: true probability of success is not equal to 0.003992016</span></span>
<span><span class="co">#&gt; 95 percent confidence interval:</span></span>
<span><span class="co">#&gt;  0.1069843 0.1492400</span></span>
<span><span class="co">#&gt; sample estimates:</span></span>
<span><span class="co">#&gt; frequency of outliers (expected: 0.00399201596806387 ) </span></span>
<span><span class="co">#&gt;                                                  0.127</span></span>
<span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/testSpatialAutocorrelation.html" class="external-link">testSpatialAutocorrelation</a></span><span class="op">(</span><span class="va">r_pois</span>, x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">X</span>, y <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span></code></pre>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-3.png" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa Moran's I test for distance-based autocorrelation</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r_pois</span></span>
<span><span class="co">#&gt; observed = 0.0020776, expected = -0.0010010, sd = 0.0026262, p-value =</span></span>
<span><span class="co">#&gt; 0.2411</span></span>
<span><span class="co">#&gt; alternative hypothesis: Distance-based autocorrelation</span></span>
<span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/testZeroInflation.html" class="external-link">testZeroInflation</a></span><span class="op">(</span><span class="va">r_pois</span><span class="op">)</span></span></code></pre>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-4.png" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa zero-inflation test via comparison to expected zeros with</span></span>
<span><span class="co">#&gt;  simulation under H0 = fitted model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; ratioObsSim = 1.7992, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two.sided</span></span></code></pre>
<p>In the QQ residual plots we clearly see evidence of over dispersion
compared to the Poisson. Note the values clumping near 1.0 on the
observed axis and deviating downwards towards 0.0 observed. This is
indicative of too many zeros and especially too many large values
compared to the assumed Poisson distribution.</p>
<p>Lets try with the correct model:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_nb2</span>, nsim <span class="op">=</span> <span class="fl">300</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">fit_nb2</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Everything looks fine. But, again, the MCMC-based residuals above are
likely the best approach.</p>
<p>What about the model where we were missing a predictor?</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_fixed</span> <span class="op">&lt;-</span> <span class="va">fit_nb2_miss</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">linkinv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_nb2_miss</span><span class="op">)</span><span class="op">$</span><span class="va">est_non_rf</span><span class="op">)</span></span>
<span><span class="va">r_nb2_miss</span> <span class="op">&lt;-</span> <span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/createDHARMa.html" class="external-link">createDHARMa</a></span><span class="op">(</span></span>
<span>  simulatedResponse <span class="op">=</span> <span class="va">s_nb2_miss</span>,</span>
<span>  observedResponse <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">observed</span>,</span>
<span>  fittedPredictedResponse <span class="op">=</span> <span class="va">pred_fixed</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r_nb2_miss</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>This looks fine so far, but the plot on the right represents
simulated residuals against the prediction without the random effects,
which here is just an intercept. Lets try plotting the residuals against
the missing predictor:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/plotResiduals.html" class="external-link">plotResiduals</a></span><span class="op">(</span><span class="va">r_nb2_miss</span>, form <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">a1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>We can see a slight trend in the residuals against ‘a1’ since we have
missed including it in the model.</p>
<p>We can also see the difference in the log likelihood or by using the
<code><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC()</a></code> method:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># negative log likelihood is lower; </span></span>
<span><span class="co"># i.e. log likelihood is higher, but we do have one more parameter</span></span>
<span><span class="va">fit_nb2</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">objective</span></span>
<span><span class="co">#&gt; [1] 1542.78</span></span>
<span><span class="co">#&gt; attr(,"logarithm")</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">fit_nb2_miss</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">objective</span></span>
<span><span class="co">#&gt; [1] 1572.703</span></span>
<span><span class="co">#&gt; attr(,"logarithm")</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_nb2_miss</span>, <span class="va">fit_nb2</span><span class="op">)</span> <span class="co"># AIC supports including the 'a1' predictor</span></span>
<span><span class="co">#&gt;              df      AIC</span></span>
<span><span class="co">#&gt; fit_nb2_miss  4 3153.407</span></span>
<span><span class="co">#&gt; fit_nb2       5 3095.560</span></span></code></pre></div>
<p>For help interpreting the DHARMa residual plots, see
<code><a href="https://cran.rstudio.com/web/packages/DHARMa/vignettes/DHARMa.html" class="external-link">vignette("DHARMa", package="DHARMa")</a></code>.</p>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Dunn, P.K., and Smyth, G.K. 1996. Randomized Quantile Residuals.
Journal of Computational and Graphical Statistics 5(3): 236–244.</p>
<p>Rufener, M.-C., Kristensen, K., Nielsen, J.R., and Bastardie, F.
2021. Bridging the gap between commercial fisheries and survey data to
model the spatiotemporal dynamics of marine species. Ecological
Applications In press: e02453.</p>
<p>Thygesen, U.H., Albertsen, C.M., Berg, C.W., Kristensen, K., and
Nielsen, A. 2017. Validation of ecological state space models using the
Laplace approximation. Environ Ecol Stat 24(2): 317–339.</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
